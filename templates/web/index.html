<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T3V Helper - Diễn đàn hỏi đáp</title>
    <link rel="stylesheet" href="/templates/static/css/sidebar.css" />
    <link rel="stylesheet" href="/templates/static/css/forums.css" />
    <link rel="stylesheet" href="/templates/static/css/home.css" />
    <link rel="stylesheet" href="/templates/static/css/chat_clients.css" />
    <link rel="stylesheet" href="/templates/static/css/Courses.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css"
    />
    <link rel="icon" href="/templates/static/images/logoT3V.png" />

    <style>
      main {
        margin-top: 60px; /* đẩy nội dung main xuống dưới thanh header */
        max-height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="sidebar-container"></div>
    <script src="/templates/static/js/sidebar.js"></script>
    <script>
      // Hàm tải sidebar và khởi tạo
      fetch("/sidebar.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("sidebar-container").innerHTML = html;
          initSidebar(); // Hàm initSidebar() từ sidebar.js

          // Sau khi sidebar được tải, khởi tạo logic điều hướng
          initNavigation();
        });
    </script>

    <main id="main-content">
      <p>Đang tải nội dung...</p>
    </main>

    <script>
      // Hàm tải nội dung
      async function loadContent(url, pushState = true) {
        const mainContentArea = document.getElementById("main-content");
        if (!mainContentArea) return;

        mainContentArea.innerHTML =
          '<p class="loading-indicator">Đang tải nội dung...</p>';

        try {
          const response = await fetch(url);
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);

          const html = await response.text();
          mainContentArea.innerHTML = html;

          // Xử lý các script trong nội dung tải về
          const scripts = mainContentArea.querySelectorAll("script");
          scripts.forEach((oldScript) => {
            const newScript = document.createElement("script");
            if (oldScript.src) {
              newScript.src = oldScript.src;
              newScript.async = false;
            } else {
              newScript.textContent = oldScript.textContent;
            }
            document.body.appendChild(newScript);
          });

          if (pushState && window.location.pathname !== url) {
            history.pushState({ url }, "", url);
          }
        } catch (err) {
          console.error("Lỗi khi tải nội dung:", err);
          mainContentArea.innerHTML = `<p class="error-message">Lỗi khi tải nội dung: ${err.message}</p>`;
        }
      }

      // Xử lý sự kiện popstate
      window.addEventListener("popstate", function (event) {
        const path = event.state?.url || "home.html";
        loadContent(path, false);
      });

      // Khởi tạo trang
      document.addEventListener("DOMContentLoaded", function () {
        // Load sidebar
        fetch("/sidebar.html")
          .then((res) => res.text())
          .then((html) => {
            document.getElementById("sidebar-container").innerHTML = html;
            initSidebar();
            initNavigation();

            // Load nội dung ban đầu dựa trên URL
            const path = window.location.pathname;
            if (path === "/" || path === "/index.html" || path === "") {
              loadContent("home.html", false);
            } else if (!path.includes(".html")) {
              loadContent(path + ".html", false);
            }
          });
      });

      function initNavigation() {
        document.addEventListener("click", function (event) {
          const link = event.target.closest(".menu_item a");
          if (link && link.href) {
            event.preventDefault();
            const url = link.getAttribute("href");
            if (url && url !== "#") {
              loadContent(url);
            }
          }
        });
      }
    </script>
  </body>
</html>
